document.addEventListener("DOMContentLoaded", function () {
    // Toggle password visibility
    const togglePassword = document.querySelector("#togglePassword");
    const password = document.querySelector("#password");
    
    if (togglePassword != null) {
        togglePassword.addEventListener("click", function () {
            const type = password.getAttribute("type") === "password" ? "text" : "password";
            password.setAttribute("type", type);
            this.classList.toggle("bi-eye");
        });
    }

    if ($.validator) {
        $('#loginform').validate({
            rules: {
                Email: {
                    required: true,
                    email: true
                },
                Password: {
                    required: true,
                    minlength: 8
                }
            },
            messages: {
                Email: {
                    required: "Email is required",
                    email: "Please enter a valid email address"
                },
                Password: {
                    required: "Password is required",
                    minlength: "Password should be at least 8 characters"
                }
            }
        });
    }
    $('#tempMessage').delay(2000).fadeOut(1000);
});

function isValidEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

function navigateToForgotPassword() {
    let email = document.getElementById('Email').value;
    
    // Get the base URL for the forgot password page
    var forgotPasswordUrl = '/Home/ForgotPassword';
    console.log(email.length);
    if (email.length > 0) {
        window.location.href = forgotPasswordUrl + '?email=' + encodeURIComponent(email);
    } else {
        window.location.href = forgotPasswordUrl;
    }
}using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authentication;
using Service.Interfaces;
using Entity.ViewModel;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;

namespace Web.Controllers
{
    public class HomeController : Controller
    {
        private readonly IAuthService _authService;
        private readonly IConfiguration _config;

        public HomeController(IAuthService authService, IConfiguration config)
        {
            _authService = authService;
            _config = config;
        }

        public IActionResult Index()
        {
            if (Request.Cookies["Email"] != null)
            {
                return RedirectToAction("Users", "Main");
            }
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> Login(UserDemo model)
        {
            if (!ModelState.IsValid)
            {
                return View("Index", model);
            }

            bool success = await _authService.LoginAsync(model.Email, model.Password);
            if (!success)
            {
                TempData["Message"] = "Invalid Credentials";
                return View("Index", model);
            }

            string userRole = await _authService.GetRoleByEmailAsync(model.Email);

            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.ASCII.GetBytes(_config["Jwt:Key"]);

            var tokenDescriptor = new SecurityTokenDescriptor
            {
                Subject = new ClaimsIdentity(new Claim[]
                {
                    new Claim(ClaimTypes.Name, model.Email),
                    new Claim(ClaimTypes.Email, model.Email),
                    new Claim(ClaimTypes.Role, userRole)
                }),
                Expires = DateTime.UtcNow.AddHours(1),
                Issuer = _config["Jwt:Issuer"],
                Audience = _config["Jwt:Audience"],
                SigningCredentials = new SigningCredentials(
                    new SymmetricSecurityKey(key),
                    SecurityAlgorithms.HmacSha256Signature)
            };

            var token = tokenHandler.CreateToken(tokenDescriptor);
            string tokenString = tokenHandler.WriteToken(token);

            HttpContext.Session.SetString("Token", tokenString);
            HttpContext.Session.SetString("Email", model.Email);
            HttpContext.Session.SetString("Role", userRole);

            var cookieOptions = new CookieOptions()
            {
                Expires = DateTime.Now.AddDays(30),
                HttpOnly = true,
                Secure = true,
                SameSite = SameSiteMode.Strict
            };

            Response.Cookies.Append("Jwt", tokenString, cookieOptions);

            if (model.IsRemember)
            {
                Response.Cookies.Append("Email", model.Email, cookieOptions);
            }

            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, model.Email),
                new Claim(ClaimTypes.Role, userRole)
            };

            var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
            var principal = new ClaimsPrincipal(identity);

            await HttpContext.SignInAsync(
                CookieAuthenticationDefaults.AuthenticationScheme,
                principal,
                new AuthenticationProperties
                {
                    IsPersistent = model.IsRemember,
                    ExpiresUtc = model.IsRemember ? DateTime.UtcNow.AddDays(30) : null
                });

            return RedirectToAction("Users", "Main");
        }
        public IActionResult AccessDenied()
        {
            return View();
        }
        public async Task<IActionResult> ForgotPassword(string email)
        {
            var vm = new UserEmail();
            if (!string.IsNullOrEmpty(email))
            {
                vm.Email = email;
            }
            return View(vm);
        }
        [HttpPost]
        public async Task<IActionResult> SendEmailLink(UserEmail model)
        {
            if (!ModelState.IsValid)
            {
                return View("ForgotPassword", model);
            }

            try
            {
                bool isEmailSent = await _authService.SendPasswordResetEmailAsync(model.Email);
                if (isEmailSent)
                {
                    TempData["SuccessMessage"] = "Password reset link has been sent to your email.";
                    return RedirectToAction("Index", "Home");
                }
                else
                {
                    ModelState.AddModelError("Email", "No account found with this email address.");
                    return View("ForgotPassword", model);
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError("", "An error occurred while processing your request. Please try again later.");
                return View("ForgotPassword", model);
            }
        }


        [HttpGet]
        public IActionResult ResetPassword(string email)
        {
            return View(new ResetPasswordModel { Email = email });
        }

        [HttpPost]
        public async Task<IActionResult> ResetPassword(ResetPasswordModel model)
        {
            if (!ModelState.IsValid)
            {
                return View(model);
            }

            var userExists = await _authService.IsUserExistsAsync(model.Email);
            if (!userExists)
            {
                return RedirectToAction("Index", "Home");
            }

            await _authService.ResetPasswordAsync(model.Email, model.NewPassword);

            return RedirectToAction("Index", "Home");
        }
    }
}@model Entity.ViewModel.UserEmail
@{
    ViewData["Title"] = "Forgot Password Page";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="row d-flex justify-content-center align-items-center">
    <img class="col" src="~/images/logos/pizzashop_logo.png" height="70px" width="70px">
    <div class="col fs-2 pizza-shop-header">
        PIZZASHOP
    </div>
</div>
<form asp-controller="Home" asp-action="SendEmailLink" method="post" class="row" id="forgotPasswordForm">
    <div class="row w-100">
        <p class="col fs-3 welcome-text mx-8 my-1">Forgot Password</p>
    </div>
    <div class="row w-100">
        <P class="col mx-8 my-1 recover-text"> enter your email and we'll send you a link to reset your password.</P>
    </div>
    <div class="row w-100">
        <input type="text" placeholder="Email" asp-for="Email" class="icon-email col mx-8 my-2">
    </div>
    <div class="row w-100">
        <span asp-validation-for="Email" class="text-danger col mx-8"></span>
    </div>
    <div class="row d-flex w-100">
        <button class="send-button col mx-8 my-2" type="submit">Send</button>
    </div>
    <div class="row w-100">
        <div class="col d-flex w-100 justify-content-center align-items-center my-2">
            <a class="row text-decoration-none" asp-controller="Home" asp-action="Index">
                Back to Login
            </a>
        </div>
    </div>
</form>
@section Scripts {
    <script>
        // Prevent validation from showing on page load
        $(document).ready(function() {
            // Reset validation state
            $("form").removeData("validator");
            $("form").removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse("form");
            
            // Only show validation after first interaction
            $("form").on("submit", function() {
                $(this).validate();
            });
        });
    </script>
}@model Entity.ViewModel.UserDemo
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="row d-flex justify-content-center align-items-center">
    <img class="col" src="~/images/logos/pizzashop_logo.png" height="70px" width="70px">
    <div class="col fs-2 pizza-shop-header">
        PIZZASHOP
    </div>
</div>
<div class="row w-100 p-0">
    <p class="col fs-3 welcome-text mx-8 my-1 p-0">Welcome,</p>
</div>
<form asp-controller="Home" asp-action="login" method="post" class="row" id=loginform>
    <div class="row w-100 ">
        <div class="col mx-8 my-2 p-0 w-100">
            <input type="email" asp-for="Email" id="Email" name="Email" placeholder="Email" class="icon-email w-100">
        </div>
    </div>

    <div class="row w-100">
        <div class="col mx-8 my-2 position-relative w-100 p-0">
            <input type="password" asp-for="Password" placeholder="Password" name="Password"
                class="icon-password col w-100 align-items-center" id="password">
            <i class="bi bi-eye-slash" id="togglePassword"></i>
            <div><strong class="text-danger" id="tempMessage">@TempData["Message"]</strong></div>
        </div>
    </div>
    <div class="row w-100 d-flex align-items-center justify-content-center my-3">
        <div class="form-check col mx-8 d-flex">
            <input type="checkbox" asp-for="IsRemember" class="form-check-input row" id="exampleCheck1">
            <label class="form-check-label row mx-3 " for="exampleCheck1" asp-for="IsRemember">Remember Me</label>
            <div class="col forgot-password-div">
                <a class="forgot-password-link" onclick="navigateToForgotPassword()">Forgot Password?</a>
            </div>
        </div>
    </div>
    <div class="row w-100">
        <button type="submit" class="login-button col mx-8 my-2">Login</button>
    </div>
</form>
<script src="~/js/site.js"></script>
